<!DOCTYPE html>
<html>
<head>
    
    <title>Revisions - Stack Overflow</title>
    <link rel="shortcut icon" href="//cdn.sstatic.net/stackoverflow/img/favicon.ico">
    <link rel="apple-touch-icon image_src" href="//cdn.sstatic.net/stackoverflow/img/apple-touch-icon.png">
    <link rel="search" type="application/opensearchdescription+xml" title="Stack Overflow" href="/opensearch.xml">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:domain" content="stackoverflow.com"/>
    <meta name="og:type" content="website" />
    <meta name="og:image" content="http://cdn.sstatic.net/stackoverflow/img/apple-touch-icon@2.png?v=fde65a5a78c6"/>
    <meta name="og:title" content="Revisions" />
    <meta name="og:description" content="Q&amp;A for professional and enthusiast programmers" />
    <meta name="og:url" content="http://stackoverflow.com/posts/4300127/revisions"/>

    
    
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="//cdn.sstatic.net/Js/stub.en.js?v=e3d47b73fa12" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.sstatic.net/stackoverflow/all.css?v=fb1a82aefb3b">
    

    <script type="text/javascript">
        StackExchange.init({"locale":"en","stackAuthUrl":"https://stackauth.com","serverTime":1385422121,"styleCode":true,"enableUserHovercards":true,"site":{"name":"Stack Overflow","description":"Q&A for professional and enthusiast programmers","isNoticesTabEnabled":true,"recaptchaPublicKey":"6LdchgIAAAAAAJwGpIzRQSOFaO0pU6s44Xt8aTwc","enableSocialMediaInSharePopup":true},"user":{"fkey":"f51c005c36aeb04be7163e16a81b52d5","isAnonymous":true}});
        StackExchange.using.setCacheBreakers({"js/prettify-full.en.js":"e0bbd4760e83","js/moderator.en.js":"1a411fd265fe","js/full-anon.en.js":"8a881a0975af","js/full.en.js":"e87912181c10","js/wmd.en.js":"bd9234d44a40","js/third-party/jquery.autocomplete.min.js":"e5f01e97f7c3","js/third-party/jquery.autocomplete.min.en.js":"","js/mobile.en.js":"d1d834ef85d2","js/help.en.js":"d3cc74d8a93a","js/tageditor.en.js":"6d51a5f8d7f3","js/tageditornew.en.js":"111b781cf314","js/inline-tag-editing.en.js":"f951bd09dc69","js/revisions.en.js":"33fd38144303","js/review.en.js":"f45b4ec094ea","js/tagsuggestions.en.js":"e4e7b952fcc7","js/post-validation.en.js":"c275fe37d674","js/explore-qlist.en.js":"73825bd006fc","js/events.en.js":"53bc48767091"});
        StackExchange.using("gps", function() {
             StackExchange.gps.init(true);
        });
        
    </script>
    
        <script type="text/javascript">
            StackExchange.ready(function () {
                $('#nav-tour').click(function () {
                    StackExchange.using("gps", function() {
                        StackExchange.gps.track("aboutpage.click", { aboutclick_location: "headermain" }, true);
                    });
                });
            });
        </script>
</head>
<body class="revision-page">
    <noscript><div id="noscript-padding"></div></noscript>
    <div id="notify-container"></div>
    <div id="overlay-header"></div>
    <div id="custom-header"></div>
    <div class="container">
        <div id="header" class=headeranon>
            <div id="portalLink">
                <a class="genu" href="http://stackexchange.com" onclick="StackExchange.ready(function(){genuwine.click();});return false;">Stack Exchange</a>
            </div>
            <div id="topbar">
                <div id="hlinks">
                    
<span id="hlinks-user"></span>
<span id="hlinks-nav">                        <a href="/users/login?returnurl=%2fposts%2f4300127%2frevisions">sign up</a>

 <span class="lsep">|</span>
                    <a href="/users/login?returnurl=%2fposts%2f4300127%2frevisions">log in</a>

 <span class="lsep">|</span>
                    <a href="http://careers.stackoverflow.com">careers 2.0</a>

 <span class="lsep">|</span>
</span>
<span id="hlinks-custom"></span>
                </div>
                <div id="hsearch">
                    <form id="search" action="/search" method="get" autocomplete="off">
                        <div>
                            <input autocomplete="off" name="q" class="textbox" placeholder="search" tabindex="1" type="text" maxlength="240" size="28" value="">
                        </div>
                    </form>
                </div>
            </div>
            <br class="cbt">
            <div id="hlogo">
                <a href="/">
                    Stack Overflow
                </a>
            </div>
            <div id="hmenus">
                <div class="nav mainnavs mainnavsanon">
                    <ul>
                            <li><a id="nav-questions" href="/questions">Questions</a></li>
                            <li><a id="nav-tags" href="/tags">Tags</a></li>
                            <li><a id="nav-tour" href="/about">Tour</a></li>
                            <li><a id="nav-users" href="/users">Users</a></li>
                    </ul>
                </div>
                <div class="nav askquestion">
                    <ul>
                        <li>
                            <a id="nav-askquestion"  href="/questions/ask">Ask Question</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        



        <div id="content">
            


<div id="mainbar-full">

    <div class="subheader">
        <h1><a href="/questions/4300127/problem-with-redirection-and-pipelining-in-my-simple-unix-shell" class="question-hyperlink">Return to Question</a></h1>
    </div>

    <div id="revisions">
        <table>
                <tr class="owner-revision">
                    <td class="revcell1 vm" onclick="StackExchange.revisions.toggle('8f29735d-d81f-4dfe-9767-b457d0c416b2') ">
                        <span id="rev-arrow-8f29735d-d81f-4dfe-9767-b457d0c416b2" class="expander-arrow-show" title="show/hide this revision&#39;s text"></span>
                    </td>
                    <td class="revcell2 vm" onclick="StackExchange.revisions.toggle('8f29735d-d81f-4dfe-9767-b457d0c416b2') ">
                        <span title="revision 2">2</span>
                    </td>
                    <td class="revcell3 vm">
                        <span class="revision-comment">added 294 characters in body; deleted 16 characters in body</span>
                        <div class="post-menu" style="padding-top: 10px;">
                            <a href="/revisions/8f29735d-d81f-4dfe-9767-b457d0c416b2/view-source" title="view raw text of this revision" target="_blank">source</a><span class="lsep">|</span><a class="single-revision" href="/revisions/4300127/2" title="link to this formatted revision">link</a>
                        </div>
                    </td>
                    <td class="revcell4">

<div class="user-info ">
    <div class="user-action-time">
        edited <span title="2010-11-29 01:14:32Z" class="relativetime">Nov 29 '10 at 1:14</span>
    </div>
    <div class="user-gravatar32">
        <a href="/users/523332/d-nikitas"><div><img src="https://www.gravatar.com/avatar/ef3cc7209536784f8d9174de7e8a473b?s=32&d=identicon&r=PG" alt="" width="32" height="32"></div></a>
    </div>
    <div class="user-details">
        <a href="/users/523332/d-nikitas">D Nikitas</a><br>
        <span class="reputation-score" title="reputation score " dir="ltr">1</span><span title="2 bronze badges"><span class="badge3"></span><span class="badgecount">2</span></span>
    </div>
</div>
                    </td>
                </tr>
                <tr>
                    <td colspan="4">
                        <div id="rev8f29735d-d81f-4dfe-9767-b457d0c416b2" class="revcell5" style="display: block">


<div class="diff-choices">
    <a href="#" class="action inline-html-diff selected" title="Show the rendered output with additions and removals inline">inline</a>
    <a href="#" class="action sidebyside-html-diff" title="Show the rendered output diffs side-by-side">side-by-side</a>
    <a href="#" class="action sidebyside-markdown-diff" title="Show the markdown source diffs side-by-side">side-by-side markdown</a>
    <br class="cbt" />
</div>

<div class="diffs">

        <div class="post-text inline-diff condensed">
            <p> EDIT:<span class="diff-delete"> While</span><span class="diff-add"> I can't get some of</span> the<span class="diff-delete"> code looks fine in preview</span><span class="diff-add"> indents to work correctly</span>,<span class="diff-delete"> it's not all in a code block when viewed on</span><span class="diff-add"> but</span> the<span class="diff-delete"> main site</span><span class="diff-add"> code is complete and blocked correctly</span>.<span class="diff-delete"> I'm currently fixing it</span><span class="diff-add"> Sorry</span>.</p><div class="diff-skipped"><div></div></div><p><pre><span class="diff-delete">
pid_t runproc(int fd[][2], int num, Command_line *cmd);</span></p><span class="diff-delete">

</span><p><span class="diff-delete">void execute_command_line(Command_line *cmd) {
  int n;
  int temp_pipe[2];
  int fd[MAX_PROGS-1][2];
  pid_t pids[MAX_PROGS];</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/* Clears pipes (sets all values to -1*/
  for(n = 0; n &lt; cmd->num_progs; n++){
    fd[n][0] = -1;
    fd[n][1] = -1;
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/*Uses temp_pipe to connect write end of nth pipe to read end of (n+1)th 
    pipe*/
  for(n = 0; n &lt; cmd->num_progs - 1; n++){
    pipe(temp_pipe);
    fd[n][1] = temp_pipe[1];
    fd[n+1][0] = temp_pipe[0];
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">If input file redirection is occuring, redirects read end of first pipe to
    file</span></em><span class="diff-delete">/
  if(cmd->infile){
    fd[0][0] = open(cmd->infile, O_RDONLY);
    if(fd[0][0] &lt; 0){
      printf("Error executing command\n");
      exit(1);
    }
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">If output file redirection is occurring, redirects write end of last pipe to
    file. Sets append option according to append field of command</span></em><span class="diff-delete">/
  if(cmd->outfile){
    if(cmd->append){
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_APPEND | O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }else{
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Runs runproc for every program in pipe, stores return values (pids of
    children) in array</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    pids[n] = runproc(fd, n, cmd);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Closes all pipes</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    if(fd[n][0] >= 0) close(fd[n][0]);
    if(fd[n][1] >= 0) close(fd[n][1]);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Waits for all children</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    wait(NULL);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">}</span></p><span class="diff-delete">

</span><p><span class="diff-delete">pid_t runproc(int fd[][2], int num, Command_line *cmd){
  pid_t pid;
  int n;
  int frk_chk;</span></p><span class="diff-delete">

</span><p><span class="diff-delete">pid = fork();
  if(pid &lt; 0){
    printf("Error executing command\n");
    exit(1);
  }else if (!pid){ /</span><em><span class="diff-delete">Child code</span></em><span class="diff-delete">/
    /</span><em><span class="diff-delete">Redirects stdin/stdout of process to read/write end of corresponding
      pipe</span></em><span class="diff-delete">/
    printf("one\n");
    if(fd[num][0] >= 0) dup2(fd[num][0], STDIN_FILENO);
    if(fd[num][1] >= 0) dup2(fd[num][1], STDOUT_FILENO);</span></p><span class="diff-delete">

</span><span class="diff-add">&nbsp;</span><pre><code><span class="diff-add">pid_t runproc(int fd[][2], int num, Command_line *cmd);

void execute_command_line(Command_line *cmd) {
  int n;
  int temp_pipe[2];
  int fd[MAX_PROGS-1][2];
  pid_t pids[MAX_PROGS];

  </span>/<span class="diff-delete">*Closes</span><span class="diff-add">* Clears pipes (sets all values to -1*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
 </span> <span class="diff-add">  fd[n][0] = -1;
    fd[n][1] = -1;
  }

  /*Uses temp_pipe to connect write end of nth </span>pipe <span class="diff-delete">ends*</span><span class="diff-add">to read end of (n+1)th 
    pipe*/
  for(n = 0; n &lt; cmd-&gt;num_progs - 1; n++){
    pipe(temp_pipe);
    fd[n][1] = temp_pipe[1];
    fd[n+1][0] = temp_pipe[0];
  }

  /*If input file redirection is occuring, redirects read end of first pipe to
    file*</span>/<span class="diff-add">
  if(cmd-&gt;infile){
    fd[0][0] = open(cmd-&gt;infile, O_RDONLY);
    if(fd[0][0] &lt; 0){</span>
<span class="diff-add">      </span>printf(<span class="diff-delete">"two\n"</span><span class="diff-add">"Error executing command\n");
      exit(1);
    }
  }

  /*If output file redirection is occurring, redirects write end of last pipe to
    file. Sets append option according to append field of command*/
  if(cmd-&gt;outfile){
    if(cmd-&gt;append){
      fd[cmd-&gt;num_progs - 1][1] = open(cmd-&gt;outfile, O_APPEND | O_WRONLY);
      if(fd[cmd-&gt;num_progs - 1][1] &lt; 0</span>)<span class="diff-add">{
printf("Error executing command\n")</span>;
<span class="diff-add">exit(1);
      }
    }else{
      fd[cmd-&gt;num_progs - 1][1] = open(cmd-&gt;outfile, O_WRONLY);
      if(fd[cmd-&gt;num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }
  }

  /*Runs runproc for every program in pipe, stores return values (pids of
    children) in array*/
  </span>for(<span class="diff-add">n = 0; n &lt; cmd-&gt;num_progs; n++){
    pids[n] = runproc(fd, n, cmd);
  }

  /*Closes all pipes*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
    if(fd[n][0] &gt;= 0) close(fd[n][0]);
    if(fd[n][1] &gt;= 0) close(fd[n][1]);
  }

  /*Waits for all children*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
    wait(NULL);
  }

}

pid_t runproc(int fd[][2], int num, Command_line *cmd){
  pid_t pid;
  int n;
  int frk_chk;

  pid = fork();
  if(pid &lt; 0){
    printf("Error executing command\n");
    exit(1);
  }else if (!pid){ /*Child code*/
    /*Redirects stdin/stdout of process to read/write end of corresponding
      pipe*/
    if(fd[num][0] &gt;= 0) dup2(fd[num][0], STDIN_FILENO);
    if(fd[num][1] &gt;= 0) dup2(fd[num][1], STDOUT_FILENO);

    /*Closes pipe ends*/
    for(</span>n=0; n &lt; cmd-&gt;num_progs - 1; n++){
<span class="diff-add">    </span>  if(fd[num][0] &gt;= 0) close(fd[num][0]);
  <span class="diff-add">    </span>if(fd[num][1] &gt;= 0) close(fd[num][1]);
<span class="diff-add">    </span>}

<span class="diff-add">    </span>/*If backgrounding: forks, parent exits, child executes program. 
<span class="diff-add">   </span>  <span class="diff-add"> </span>If not backgrounding: program just executes*/<span class="diff-delete">
printf("three\n");</span>
<span class="diff-add">    </span>if(cmd-&gt;bg){
<span class="diff-add">    </span>  if((frk_chk = fork()) &lt; 0<span class="diff-add">){
 printf("Error executing command\n");
 exit(1);
      }else if(frk_chk){
 exit(0);
      }else{
 if(!(cmd-&gt;infile) &amp;&amp; num == 0) close(STDIN_FILENO);
 execvp(cmd-&gt;argvs[num][0], cmd-&gt;argvs[num]);
      }
    }else{
      if(!num){
 dup2(fd[0][1], STDOUT_FILENO);
      }
      execvp(cmd-&gt;argvs[num][0], cmd-&gt;argvs[num]);
    }
    printf("Error executing command\n"</span>)<span class="diff-add">;
    exit(1);
  }else</span>{<span class="diff-add"> /*Parent code*/
    /*Returns pid of child, used for reaping loop*/
    return pid;</span>
<span class="diff-add">  }
}
</span></code></pre><p><span class="diff-delete"> printf("Error executing command\n");
 exit(1);
      }else if(frk_chk){
 exit(0);
      }else{
 if(!(cmd->infile) &amp;&amp; num == 0) close(STDIN_FILENO);
 execvp(cmd->argvs[num][0], cmd->argvs[num]);
      }
    }else{
      printf("four %d\n", num);
      if(!num){
 dup2(fd[0][1], STDOUT_FILENO);
      }
      execvp(cmd->argvs[num][0], cmd->argvs[num]);
    }
    printf("Error executing command\n");
    exit(1);
  }else{ /</span><em><span class="diff-delete">Parent code</span></em><span class="diff-delete">/
    /</span><em><span class="diff-delete">Returns pid of child, used for reaping loop</span></em><span class="diff-delete">/
    return pid;
  }
}
</span></p>
        </div>
        <div class="sidebyside-diff dno condensed">
            <div class="post-text">
                <p> EDIT:<span class="diff-delete"> While</span> the<span class="diff-delete"> code looks fine in preview</span>,<span class="diff-delete"> it's not all in a code block when viewed on</span> the<span class="diff-delete"> main site</span>.<span class="diff-delete"> I'm currently fixing it</span>.</p><div class="diff-skipped"><div></div></div><p><pre><span class="diff-delete">
pid_t runproc(int fd[][2], int num, Command_line *cmd);</span></p><span class="diff-delete">

</span><p><span class="diff-delete">void execute_command_line(Command_line *cmd) {
  int n;
  int temp_pipe[2];
  int fd[MAX_PROGS-1][2];
  pid_t pids[MAX_PROGS];</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/* Clears pipes (sets all values to -1*/
  for(n = 0; n &lt; cmd->num_progs; n++){
    fd[n][0] = -1;
    fd[n][1] = -1;
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/*Uses temp_pipe to connect write end of nth pipe to read end of (n+1)th 
    pipe*/
  for(n = 0; n &lt; cmd->num_progs - 1; n++){
    pipe(temp_pipe);
    fd[n][1] = temp_pipe[1];
    fd[n+1][0] = temp_pipe[0];
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">If input file redirection is occuring, redirects read end of first pipe to
    file</span></em><span class="diff-delete">/
  if(cmd->infile){
    fd[0][0] = open(cmd->infile, O_RDONLY);
    if(fd[0][0] &lt; 0){
      printf("Error executing command\n");
      exit(1);
    }
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">If output file redirection is occurring, redirects write end of last pipe to
    file. Sets append option according to append field of command</span></em><span class="diff-delete">/
  if(cmd->outfile){
    if(cmd->append){
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_APPEND | O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }else{
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Runs runproc for every program in pipe, stores return values (pids of
    children) in array</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    pids[n] = runproc(fd, n, cmd);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Closes all pipes</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    if(fd[n][0] >= 0) close(fd[n][0]);
    if(fd[n][1] >= 0) close(fd[n][1]);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">/</span><em><span class="diff-delete">Waits for all children</span></em><span class="diff-delete">/
  for(n = 0; n &lt; cmd->num_progs; n++){
    wait(NULL);
  }</span></p><span class="diff-delete">

</span><p><span class="diff-delete">}</span></p><span class="diff-delete">

</span><p><span class="diff-delete">pid_t runproc(int fd[][2], int num, Command_line *cmd){
  pid_t pid;
  int n;
  int frk_chk;</span></p><span class="diff-delete">

</span><p><span class="diff-delete">pid = fork();
  if(pid &lt; 0){
    printf("Error executing command\n");
    exit(1);
  }else if (!pid){ /</span><em><span class="diff-delete">Child code</span></em><span class="diff-delete">/
    /</span><em><span class="diff-delete">Redirects stdin/stdout of process to read/write end of corresponding
      pipe</span></em><span class="diff-delete">/
    printf("one\n");
    if(fd[num][0] >= 0) dup2(fd[num][0], STDIN_FILENO);
    if(fd[num][1] >= 0) dup2(fd[num][1], STDOUT_FILENO);</span></p><span class="diff-delete">

</span><code>/<span class="diff-delete">*Closes</span> pipe <span class="diff-delete">ends*</span>/
printf(<span class="diff-delete">"two\n"</span>);
for(n=0; n &lt; cmd-&gt;num_progs - 1; n++){
  if(fd[num][0] &gt;= 0) close(fd[num][0]);
  if(fd[num][1] &gt;= 0) close(fd[num][1]);
}

/*If backgrounding: forks, parent exits, child executes program. 
  If not backgrounding: program just executes*/<span class="diff-delete">
printf("three\n");</span>
if(cmd-&gt;bg){
  if((frk_chk = fork()) &lt; 0){
</code></pre><p><span class="diff-delete"> printf("Error executing command\n");
 exit(1);
      }else if(frk_chk){
 exit(0);
      }else{
 if(!(cmd->infile) &amp;&amp; num == 0) close(STDIN_FILENO);
 execvp(cmd->argvs[num][0], cmd->argvs[num]);
      }
    }else{
      printf("four %d\n", num);
      if(!num){
 dup2(fd[0][1], STDOUT_FILENO);
      }
      execvp(cmd->argvs[num][0], cmd->argvs[num]);
    }
    printf("Error executing command\n");
    exit(1);
  }else{ /</span><em><span class="diff-delete">Parent code</span></em><span class="diff-delete">/
    /</span><em><span class="diff-delete">Returns pid of child, used for reaping loop</span></em><span class="diff-delete">/
    return pid;
  }
}
</span></p>
            </div>
            <div class="post-text">
                <p> EDIT:<span class="diff-add"> I can't get some of</span> the<span class="diff-add"> indents to work correctly</span>,<span class="diff-add"> but</span> the<span class="diff-add"> code is complete and blocked correctly</span>.<span class="diff-add"> Sorry</span>.</p><div class="diff-skipped"><div></div></div><span class="diff-add">&nbsp;</span><pre><code><span class="diff-add">pid_t runproc(int fd[][2], int num, Command_line *cmd);

void execute_command_line(Command_line *cmd) {
  int n;
  int temp_pipe[2];
  int fd[MAX_PROGS-1][2];
  pid_t pids[MAX_PROGS];

  </span>/<span class="diff-add">* Clears pipes (sets all values to -1*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
 </span> <span class="diff-add">  fd[n][0] = -1;
    fd[n][1] = -1;
  }

  /*Uses temp_pipe to connect write end of nth </span>pipe <span class="diff-add">to read end of (n+1)th 
    pipe*/
  for(n = 0; n &lt; cmd-&gt;num_progs - 1; n++){
    pipe(temp_pipe);
    fd[n][1] = temp_pipe[1];
    fd[n+1][0] = temp_pipe[0];
  }

  /*If input file redirection is occuring, redirects read end of first pipe to
    file*</span>/<span class="diff-add">
  if(cmd-&gt;infile){
    fd[0][0] = open(cmd-&gt;infile, O_RDONLY);
    if(fd[0][0] &lt; 0){</span>
<span class="diff-add">      </span>printf(<span class="diff-add">"Error executing command\n");
      exit(1);
    }
  }

  /*If output file redirection is occurring, redirects write end of last pipe to
    file. Sets append option according to append field of command*/
  if(cmd-&gt;outfile){
    if(cmd-&gt;append){
      fd[cmd-&gt;num_progs - 1][1] = open(cmd-&gt;outfile, O_APPEND | O_WRONLY);
      if(fd[cmd-&gt;num_progs - 1][1] &lt; 0</span>)<span class="diff-add">{
printf("Error executing command\n")</span>;
<span class="diff-add">exit(1);
      }
    }else{
      fd[cmd-&gt;num_progs - 1][1] = open(cmd-&gt;outfile, O_WRONLY);
      if(fd[cmd-&gt;num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }
  }

  /*Runs runproc for every program in pipe, stores return values (pids of
    children) in array*/
  </span>for(<span class="diff-add">n = 0; n &lt; cmd-&gt;num_progs; n++){
    pids[n] = runproc(fd, n, cmd);
  }

  /*Closes all pipes*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
    if(fd[n][0] &gt;= 0) close(fd[n][0]);
    if(fd[n][1] &gt;= 0) close(fd[n][1]);
  }

  /*Waits for all children*/
  for(n = 0; n &lt; cmd-&gt;num_progs; n++){
    wait(NULL);
  }

}

pid_t runproc(int fd[][2], int num, Command_line *cmd){
  pid_t pid;
  int n;
  int frk_chk;

  pid = fork();
  if(pid &lt; 0){
    printf("Error executing command\n");
    exit(1);
  }else if (!pid){ /*Child code*/
    /*Redirects stdin/stdout of process to read/write end of corresponding
      pipe*/
    if(fd[num][0] &gt;= 0) dup2(fd[num][0], STDIN_FILENO);
    if(fd[num][1] &gt;= 0) dup2(fd[num][1], STDOUT_FILENO);

    /*Closes pipe ends*/
    for(</span>n=0; n &lt; cmd-&gt;num_progs - 1; n++){
<span class="diff-add">    </span>  if(fd[num][0] &gt;= 0) close(fd[num][0]);
  <span class="diff-add">    </span>if(fd[num][1] &gt;= 0) close(fd[num][1]);
<span class="diff-add">    </span>}

<span class="diff-add">    </span>/*If backgrounding: forks, parent exits, child executes program. 
<span class="diff-add">   </span>  <span class="diff-add"> </span>If not backgrounding: program just executes*/
<span class="diff-add">    </span>if(cmd-&gt;bg){
<span class="diff-add">    </span>  if((frk_chk = fork()) &lt; 0<span class="diff-add">){
 printf("Error executing command\n");
 exit(1);
      }else if(frk_chk){
 exit(0);
      }else{
 if(!(cmd-&gt;infile) &amp;&amp; num == 0) close(STDIN_FILENO);
 execvp(cmd-&gt;argvs[num][0], cmd-&gt;argvs[num]);
      }
    }else{
      if(!num){
 dup2(fd[0][1], STDOUT_FILENO);
      }
      execvp(cmd-&gt;argvs[num][0], cmd-&gt;argvs[num]);
    }
    printf("Error executing command\n"</span>)<span class="diff-add">;
    exit(1);
  }else</span>{<span class="diff-add"> /*Parent code*/
    /*Returns pid of child, used for reaping loop*/
    return pid;</span>
<span class="diff-add">  }
}
</span></code></pre>
            </div>
        </div>

</div>
                        </div>
                    </td>
                </tr>
                <tr id="spacer-8f29735d-d81f-4dfe-9767-b457d0c416b2">
                    <td colspan="4" height="10px"></td>
                </tr>
                <tr class="owner-revision">
                    <td class="revcell1 vm" onclick="StackExchange.revisions.toggle('f86c4c36-3716-47f4-9b8a-29423737f83b') ">
                        <span id="rev-arrow-f86c4c36-3716-47f4-9b8a-29423737f83b" class="expander-arrow-show" title="show/hide this revision&#39;s text"></span>
                    </td>
                    <td class="revcell2 vm" onclick="StackExchange.revisions.toggle('f86c4c36-3716-47f4-9b8a-29423737f83b') ">
                        <span title="revision 1">1</span>
                    </td>
                    <td class="revcell3 vm">
                        <br>
                        <div class="post-menu" style="padding-top: 10px;">
                            <a href="/revisions/f86c4c36-3716-47f4-9b8a-29423737f83b/view-source" title="view raw text of this revision" target="_blank">source</a><span class="lsep">|</span><a class="single-revision" href="/revisions/4300127/1" title="link to this formatted revision">link</a>
                        </div>
                    </td>
                    <td class="revcell4">

<div class="user-info ">
    <div class="user-action-time">
        asked <span title="2010-11-29 01:05:22Z" class="relativetime">Nov 29 '10 at 1:05</span>
    </div>
    <div class="user-gravatar32">
        <a href="/users/523332/d-nikitas"><div><img src="https://www.gravatar.com/avatar/ef3cc7209536784f8d9174de7e8a473b?s=32&d=identicon&r=PG" alt="" width="32" height="32"></div></a>
    </div>
    <div class="user-details">
        <a href="/users/523332/d-nikitas">D Nikitas</a><br>
        <span class="reputation-score" title="reputation score " dir="ltr">1</span><span title="2 bronze badges"><span class="badge3"></span><span class="badgecount">2</span></span>
    </div>
</div>
                    </td>
                </tr>
                <tr>
                    <td colspan="4">
                        <div id="revf86c4c36-3716-47f4-9b8a-29423737f83b" class="revcell5" style="display: block">
<div class="diffs">
        <h1>Problem with redirection and pipelining in my simple UNIX shell</h1>

        <div class="post-text">
            <p>EDIT: While the code looks fine in preview, it's not all in a code block when viewed on the main site. I'm currently fixing it.</p>

<p>For a class assignment I've had to implement part of a simple UNIX shell. It must support redirection, piping, and backgrounding. I was provided with a parser that populates a struct called Command_line (I'll include the struct prototype below). My job is to write a function that processes these Command_lines (handles redirection, backgrounding, piping, and executes programs). </p>

<p>I've almost got it working but for some reason it doesn't properly handle commands of the form <em>program1 | program2 - file</em>. For example, cat &lt; file1.in | cat - file2.in. The problem doesn't seem to be in the redirection as I've written test programs to put in front of the pipe that do not require redirection but still cause the same problem. The pipelining does work in most cases; it's just these programs with "-" as an argument that cause problems.</p>

<p>When I run one of these problematic command lines, the output from the first program is printed and the process hangs up (I have to manually suspend and kill it). It does not give the user a prompt afterwards or react to input (aside from ctrl + z which I use to suspend the process).</p>

<p>Any advice on how to get this working would be much appreciated.</p>

<p>Here's the struct:</p>

<pre><code>/* This is the structure that holds the information about a parsed
 * command line.  The argvs array is an array of string vectors; in
 * other words, for some int i, argvs[i] is an array of strings.
 * You should be able to use argvs[i] in calls to one of the execv*()
 * functions.
 */
typedef struct {
  char *argvs[MAX_PROGS + 1][MAX_ARGS + 1];
  int num_progs;  /* Number of argument vectors; if &gt; 1, piping is requested */
  char *infile;   /* Name of stdin redirect file; NULL if no redirection */
  char *outfile;  /* Name of stdout redirect file; NULL if no redirection */
  int append;     /* Is output redirection appending? */
  int bg;         /* Put command into background? */
} Command_line;
</code></pre>

<p>And my code, that processes one of these structs (I've left out the #includes).</p>

<p><pre>
pid_t runproc(int fd[][2], int num, Command_line *cmd);</p>

<p>void execute_command_line(Command_line *cmd) {
  int n;
  int temp_pipe[2];
  int fd[MAX_PROGS-1][2];
  pid_t pids[MAX_PROGS];</p>

<p>/* Clears pipes (sets all values to -1*/
  for(n = 0; n &lt; cmd->num_progs; n++){
    fd[n][0] = -1;
    fd[n][1] = -1;
  }</p>

<p>/*Uses temp_pipe to connect write end of nth pipe to read end of (n+1)th 
    pipe*/
  for(n = 0; n &lt; cmd->num_progs - 1; n++){
    pipe(temp_pipe);
    fd[n][1] = temp_pipe[1];
    fd[n+1][0] = temp_pipe[0];
  }</p>

<p>/<em>If input file redirection is occuring, redirects read end of first pipe to
    file</em>/
  if(cmd->infile){
    fd[0][0] = open(cmd->infile, O_RDONLY);
    if(fd[0][0] &lt; 0){
      printf("Error executing command\n");
      exit(1);
    }
  }</p>

<p>/<em>If output file redirection is occurring, redirects write end of last pipe to
    file. Sets append option according to append field of command</em>/
  if(cmd->outfile){
    if(cmd->append){
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_APPEND | O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }else{
      fd[cmd->num_progs - 1][1] = open(cmd->outfile, O_WRONLY);
      if(fd[cmd->num_progs - 1][1] &lt; 0){
 printf("Error executing command\n");
 exit(1);
      }
    }
  }</p>

<p>/<em>Runs runproc for every program in pipe, stores return values (pids of
    children) in array</em>/
  for(n = 0; n &lt; cmd->num_progs; n++){
    pids[n] = runproc(fd, n, cmd);
  }</p>

<p>/<em>Closes all pipes</em>/
  for(n = 0; n &lt; cmd->num_progs; n++){
    if(fd[n][0] >= 0) close(fd[n][0]);
    if(fd[n][1] >= 0) close(fd[n][1]);
  }</p>

<p>/<em>Waits for all children</em>/
  for(n = 0; n &lt; cmd->num_progs; n++){
    wait(NULL);
  }</p>

<p>}</p>

<p>pid_t runproc(int fd[][2], int num, Command_line *cmd){
  pid_t pid;
  int n;
  int frk_chk;</p>

<p>pid = fork();
  if(pid &lt; 0){
    printf("Error executing command\n");
    exit(1);
  }else if (!pid){ /<em>Child code</em>/
    /<em>Redirects stdin/stdout of process to read/write end of corresponding
      pipe</em>/
    printf("one\n");
    if(fd[num][0] >= 0) dup2(fd[num][0], STDIN_FILENO);
    if(fd[num][1] >= 0) dup2(fd[num][1], STDOUT_FILENO);</p>

<code>/*Closes pipe ends*/
printf("two\n");
for(n=0; n &lt; cmd-&gt;num_progs - 1; n++){
  if(fd[num][0] &gt;= 0) close(fd[num][0]);
  if(fd[num][1] &gt;= 0) close(fd[num][1]);
}

/*If backgrounding: forks, parent exits, child executes program. 
  If not backgrounding: program just executes*/
printf("three\n");
if(cmd-&gt;bg){
  if((frk_chk = fork()) &lt; 0){
</code></pre>

<p>printf("Error executing command\n");
 exit(1);
      }else if(frk_chk){
 exit(0);
      }else{
 if(!(cmd->infile) &amp;&amp; num == 0) close(STDIN_FILENO);
 execvp(cmd->argvs[num][0], cmd->argvs[num]);
      }
    }else{
      printf("four %d\n", num);
      if(!num){
 dup2(fd[0][1], STDOUT_FILENO);
      }
      execvp(cmd->argvs[num][0], cmd->argvs[num]);
    }
    printf("Error executing command\n");
    exit(1);
  }else{ /<em>Parent code</em>/
    /<em>Returns pid of child, used for reaping loop</em>/
    return pid;
  }
}
</p>

        </div>

        <div class="tags-diff">
            <a href="/questions/tagged/shell" class="post-tag" title="show questions tagged &#39;shell&#39;" rel="tag">shell</a> <a href="/questions/tagged/background" class="post-tag" title="show questions tagged &#39;background&#39;" rel="tag">background</a> <a href="/questions/tagged/pipes" class="post-tag" title="show questions tagged &#39;pipes&#39;" rel="tag">pipes</a> <a href="/questions/tagged/redirect" class="post-tag" title="show questions tagged &#39;redirect&#39;" rel="tag">redirect</a> <a href="/questions/tagged/pipeline" class="post-tag" title="show questions tagged &#39;pipeline&#39;" rel="tag">pipeline</a> 
        </div>
</div>                        </div>
                    </td>
                </tr>
                <tr id="spacer-f86c4c36-3716-47f4-9b8a-29423737f83b">
                    <td colspan="4" height="10px"></td>
                </tr>

        </table>

            <div class="pager fl">
        





    </div>


    </div>
</div>

<script type="text/javascript">
    StackExchange.using("revisions", function () { StackExchange.revisions.init(4300127) });
</script>

<div style="display:none" id="prettify-lang">lang-sh</div>
        </div>
    </div>
    <div id="footer" class="categories">
        <div class="footerwrap">
            <div id="footer-menu">
                <div class="top-footer-links">
                        <a href="/about">about</a>
                    <a href="/help">help</a>
                        <a href="/help/badges">badges</a>
                    <a href="http://blog.stackexchange.com?blb=1">blog</a>
                        <a href="http://chat.stackoverflow.com">chat</a>
                    <a href="http://data.stackexchange.com">data</a>
                    <a href="http://stackexchange.com/legal">legal</a>
                    <a href="http://stackexchange.com/legal/privacy-policy">privacy policy</a>
                    <a href="http://stackexchange.com/about/hiring">jobs</a>
                    <a href="http://engine.adzerk.net/r?e=eyJhdiI6NDE0LCJhdCI6MjAsImNtIjo5NTQsImNoIjoxMTc4LCJjciI6Mjc3NiwiZG0iOjQsImZjIjoyODYyLCJmbCI6Mjc1MSwibnciOjIyLCJydiI6MCwicHIiOjExNSwic3QiOjAsInVyIjoiaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2Fib3V0L2NvbnRhY3QiLCJyZSI6MX0&amp;s=hRods5B22XvRBwWIwtIMekcyNF8">advertising info</a>

                    <a onclick='StackExchange.switchMobile("on", "/posts/4300127/revisions")'>mobile</a>
                    <b><a href="/contact">contact us</a></b>
                        <b><a href="http://meta.stackoverflow.com">feedback</a></b>
                    
                </div>
                <div id="footer-sites">
                    <table>
    <tr>
            <th colspan=3>
                Technology
            </th>
            <th >
                Life / Arts
            </th>
            <th >
                Culture / Recreation
            </th>
            <th >
                Science
            </th>
            <th >
                Other
            </th>
    </tr>
    <tr>
            <td>
                <ol>
                        <li><a href="http://stackoverflow.com" title="professional and enthusiast programmers">Stack Overflow</a></li>
                        <li><a href="http://serverfault.com" title="professional system and network administrators">Server Fault</a></li>
                        <li><a href="http://superuser.com" title="computer enthusiasts and power users">Super User</a></li>
                        <li><a href="http://webapps.stackexchange.com" title="power users of web applications">Web Applications</a></li>
                        <li><a href="http://askubuntu.com" title="Ubuntu users and developers">Ask Ubuntu</a></li>
                        <li><a href="http://webmasters.stackexchange.com" title="pro webmasters">Webmasters</a></li>
                        <li><a href="http://gamedev.stackexchange.com" title="professional and independent game developers">Game Development</a></li>
                        <li><a href="http://tex.stackexchange.com" title="users of TeX, LaTeX, ConTeXt, and related typesetting systems">TeX - LaTeX</a></li>
                            </ol></td><td><ol>
                        <li><a href="http://programmers.stackexchange.com" title="professional programmers interested in conceptual questions about software development">Programmers</a></li>
                        <li><a href="http://unix.stackexchange.com" title="users of Linux, FreeBSD and other Un*x-like operating systems.">Unix &amp; Linux</a></li>
                        <li><a href="http://apple.stackexchange.com" title="power users of Apple hardware and software">Ask Different (Apple)</a></li>
                        <li><a href="http://wordpress.stackexchange.com" title="WordPress developers and administrators">WordPress Answers</a></li>
                        <li><a href="http://gis.stackexchange.com" title="cartographers, geographers and GIS professionals">Geographic Information Systems</a></li>
                        <li><a href="http://electronics.stackexchange.com" title="electronics and electrical engineering professionals, students, and enthusiasts">Electrical Engineering</a></li>
                        <li><a href="http://android.stackexchange.com" title="enthusiasts and power users of the Android operating system">Android Enthusiasts</a></li>
                        <li><a href="http://security.stackexchange.com" title="Information security professionals">Information Security</a></li>
                            </ol></td><td><ol>
                        <li><a href="http://dba.stackexchange.com" title="database professionals who wish to improve their database skills and learn from others in the community">Database Administrators</a></li>
                        <li><a href="http://drupal.stackexchange.com" title="Drupal developers and administrators">Drupal Answers</a></li>
                        <li><a href="http://sharepoint.stackexchange.com" title="SharePoint enthusiasts">SharePoint</a></li>
                        <li><a href="http://ux.stackexchange.com" title="user experience researchers and experts">User Experience</a></li>
                        <li><a href="http://mathematica.stackexchange.com" title="users of Mathematica">Mathematica</a></li>
                    
                        <li>
                            <a href="http://stackexchange.com/sites#technology" class="more">
                                more (14)
                            </a>
                        </li>
                </ol>
            </td>
            <td>
                <ol>
                        <li><a href="http://photo.stackexchange.com" title="professional, enthusiast and amateur photographers">Photography</a></li>
                        <li><a href="http://scifi.stackexchange.com" title="science fiction and fantasy enthusiasts">Science Fiction &amp; Fantasy</a></li>
                        <li><a href="http://cooking.stackexchange.com" title="professional and amateur chefs">Seasoned Advice (cooking)</a></li>
                        <li><a href="http://diy.stackexchange.com" title="contractors and serious DIYers">Home Improvement</a></li>
                    
                        <li>
                            <a href="http://stackexchange.com/sites#lifearts" class="more">
                                more (13)
                            </a>
                        </li>
                </ol>
            </td>
            <td>
                <ol>
                        <li><a href="http://english.stackexchange.com" title="linguists, etymologists, and serious English language enthusiasts">English Language &amp; Usage</a></li>
                        <li><a href="http://skeptics.stackexchange.com" title="scientific skepticism">Skeptics</a></li>
                        <li><a href="http://judaism.stackexchange.com" title="those who base their lives on Jewish law and tradition and anyone interested in learning more">Mi Yodeya (Judaism)</a></li>
                        <li><a href="http://travel.stackexchange.com" title="road warriors and seasoned travelers">Travel</a></li>
                        <li><a href="http://christianity.stackexchange.com" title="committed Christians, experts in Christianity and those interested in learning more">Christianity</a></li>
                        <li><a href="http://gaming.stackexchange.com" title="passionate videogamers on all platforms">Arqade (gaming)</a></li>
                        <li><a href="http://bicycles.stackexchange.com" title="people who build and repair bicycles, people who train cycling, or commute on bicycles">Bicycles</a></li>
                        <li><a href="http://rpg.stackexchange.com" title="gamemasters and players of tabletop, paper-and-pencil role-playing games">Role-playing Games</a></li>
                    
                        <li>
                            <a href="http://stackexchange.com/sites#culturerecreation" class="more">
                                more (21)
                            </a>
                        </li>
                </ol>
            </td>
            <td>
                <ol>
                        <li><a href="http://math.stackexchange.com" title="people studying math at any level and professionals in related fields">Mathematics</a></li>
                        <li><a href="http://stats.stackexchange.com" title="statisticians, data analysts, data miners and data visualization experts">Cross Validated (stats)</a></li>
                        <li><a href="http://cstheory.stackexchange.com" title="theoretical computer scientists and researchers in related fields">Theoretical Computer Science</a></li>
                        <li><a href="http://physics.stackexchange.com" title="active researchers, academics and students of physics">Physics</a></li>
                        <li><a href="http://mathoverflow.net" title="professional mathematicians">MathOverflow</a></li>
                    
                        <li>
                            <a href="http://stackexchange.com/sites#science" class="more">
                                more (7)
                            </a>
                        </li>
                </ol>
            </td>
            <td>
                <ol>
                        <li><a href="http://stackapps.com" title="apps, scripts, and development with the Stack Exchange API">Stack Apps</a></li>
                        <li><a href="http://meta.stackoverflow.com" title="meta-discussion of the Stack Exchange family of Q&amp;A websites">Meta Stack Overflow</a></li>
                        <li><a href="http://area51.stackexchange.com" title="proposing new sites in the Stack Exchange network">Area 51</a></li>
                        <li><a href="http://careers.stackoverflow.com">Stack Overflow Careers</a></li>
                    
                </ol>
            </td>
    </tr>
</table>
                </div>
            </div>

            <div id="copyright">
                site design / logo &#169; 2013 stack exchange inc; user contributions licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">cc-wiki</a> 
 with <a href="http://blog.stackoverflow.com/2009/06/attribution-required/" rel="license">attribution required</a>
            </div>
            <div id="footer-flair">
                <a href="http://creativecommons.org/licenses/by-sa/3.0/" class="cc-wiki-link"></a>
            </div>
            <div id="svnrev">
                rev 2013.11.25.1177
            </div>
            
        </div>
    </div>
    <noscript>
        <div id="noscript-warning">Stack Overflow works best with JavaScript enabled<img src="http://pixel.quantserve.com/pixel/p-c1rF4kxgLUzNc.gif" alt="" class="dno"></div>
    </noscript>

    <script type="text/javascript">var _gaq=_gaq||[];_gaq.push(['_setAccount','UA-5620270-1']);
_gaq.push(['_trackPageview']);
    var _qevents = _qevents || [];
    var _comscore = _comscore || [];
    (function () {
        var ssl='https:'==document.location.protocol,
            s=document.getElementsByTagName('script')[0],
            ga=document.createElement('script');
        ga.type='text/javascript';
        ga.async=true;
        ga.src=(ssl?'https://ssl':'http://www')+'.google-analytics.com/ga.js';
        s.parentNode.insertBefore(ga,s);
        var sc=document.createElement('script');
        sc.type='text/javascript';
        sc.async=true;
        sc.src=(ssl?'https://secure':'http://edge')+'.quantserve.com/quant.js';
        s.parentNode.insertBefore(sc, s);
        
        var s = document.createElement("script"), el = document.getElementsByTagName("script")[0]; s.async = true;
        s.src = (document.location.protocol == "https:" ? "https://sb" : "http://b") + ".scorecardresearch.com/beacon.js";
        el.parentNode.insertBefore(s, el);
        
    })();
    _comscore.push({ c1: "2", c2: "17440561" });
    _qevents.push({ qacct: "p-c1rF4kxgLUzNc" });
    </script>            
</body>
</html>